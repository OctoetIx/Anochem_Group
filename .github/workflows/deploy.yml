name: Build & Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Login to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Build Backend Image
      - name: Build Backend
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USER }}/myapp-backend:${{ github.sha }} \
            -f backend/Dockerfile ./backend

      # 4. Build Frontend Image
      - name: Build Frontend
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USER }}/myapp-frontend:${{ github.sha }} \
            -f frontend/Dockerfile ./frontend

      # 5. Push images
      - name: Push Backend Image
        run: docker push ${{ secrets.DOCKERHUB_USER }}/myapp-backend:${{ github.sha }}

      - name: Push Frontend Image
        run: docker push ${{ secrets.DOCKERHUB_USER }}/myapp-frontend:${{ github.sha }}

      # 6. SSH into VPS and deploy
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            cd /root/myapp/infra

            echo "Updating image tags in .env..."
            sed -i '/^BACKEND_TAG=/d' .env
            sed -i '/^FRONTEND_TAG=/d' .env
            echo "BACKEND_TAG=${{ github.sha }}" >> .env
            echo "FRONTEND_TAG=${{ github.sha }}" >> .env

            echo "Pulling new images..."
            docker compose pull

            echo "Restarting services..."
            docker compose up -d --remove-orphans

            # Backend health check
            echo "Checking backend health..."
            for i in {1..12}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2000/api/test || echo "000")
              if [ "$status" = "200" ]; then
                echo "Backend is up!"
                break
              else
                echo "Waiting for backend... ($i/12)"
                sleep 5
              fi
            done

            # Frontend health check
            echo "Checking frontend health..."
            for i in {1..12}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "000")
              if [ "$status" = "200" ]; then
                echo "Frontend is up!"
                break
              else
                echo "Waiting for frontend... ($i/12)"
                sleep 5
              fi
            done

            echo "Deployment complete!"