name: Build & Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 0. Latest Node + npm
      - name: Setup Latest Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Update npm
        run: npm install -g npm@latest

      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Login to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Setup Buildx
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Build + Push Backend Image
      - name: Build & Push Backend
        run: |
          USER="${{ secrets.DOCKERHUB_USER }}"
          TAG="$USER/myapp-backend:${{ github.sha }}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "$TAG" \
            -f backend/Dockerfile ./backend \
            --push

      # 5. Build + Push Frontend Image
      - name: Build & Push Frontend
        run: |
          USER="${{ secrets.DOCKERHUB_USER }}"
          TAG="$USER/myapp-frontend:${{ github.sha }}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "$TAG" \
            -f frontend/Dockerfile ./frontend \
            --push

      # 6. SSH Deploy
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            set -e
            cd /root/myapp/infra

            # Write image tags
            sed -i '/^BACKEND_TAG=/d' .env
            sed -i '/^FRONTEND_TAG=/d' .env

            echo "BACKEND_TAG=${{ secrets.DOCKERHUB_USER }}/myapp-backend:${{ github.sha }}" >> .env
            echo "FRONTEND_TAG=${{ secrets.DOCKERHUB_USER }}/myapp-frontend:${{ github.sha }}" >> .env

            # Pull only updated images (redis/nginx skipped)
            docker compose pull backend frontend

            docker compose up -d --remove-orphans

            # Health checks
            echo "Checking backend..."
            for i in {1..12}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2000/api/test)
              if [ "$status" = "200" ]; then
                echo "Backend OK"
                break
              fi
              sleep 5
            done

            echo "Checking frontend..."
            for i in {1..12}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
              if [ "$status" = "200" ]; then
                echo "Frontend OK"
                break
              fi
              sleep 5
            done

            echo "Deployment complete!"