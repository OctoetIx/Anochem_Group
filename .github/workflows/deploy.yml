name: Build & Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Login to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Build and push Backend Docker Image
      - name: Build & Push Backend Image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ secrets.DOCKERHUB_USER }}/myapp-backend:${{ github.sha }} \
            -f backend/Dockerfile ./backend \
            --push

      # 5. Build and push Frontend Docker Image
      - name: Build & Push Frontend Image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ secrets.DOCKERHUB_USER }}/myapp-frontend:${{ github.sha }} \
            -f frontend/Dockerfile ./frontend \
            --push

      # 6. SSH into VPS and deploy
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            set -e

            cd /root/myapp/infra

            # Update image tags in .env
            sed -i '/^BACKEND_TAG=/d' .env
            sed -i '/^FRONTEND_TAG=/d' .env
            echo "BACKEND_TAG=${{ github.sha }}" >> .env
            echo "FRONTEND_TAG=${{ github.sha }}" >> .env

            # Pull latest images
            docker compose pull

            # Restart containers
            docker compose up -d --remove-orphans

            # --- Health Checks ---
            echo "Checking backend health..."
            for i in {1..12}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2000/api/test || echo "000")
              if [ "$status" = "200" ]; then
                echo "Backend is up!"
                break
              else
                echo "Waiting for backend... ($i/12)"
                sleep 5
              fi
            done

            echo "Checking frontend health..."
            for i in {1..12}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "000")
              if [ "$status" = "200" ]; then
                echo "Frontend is up!"
                break
              else
                echo "Waiting for frontend... ($i/12)"
                sleep 5
              fi
            done

            echo "Deployment complete!"