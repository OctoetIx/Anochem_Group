# Stage 1: build Vite app
FROM node:22-alpine AS build
WORKDIR /app

# copy lockfile + package.json first for caching
COPY package*.json ./

# install deps inside container (clean install)
RUN npm ci

# copy source and build
COPY . .
RUN npm run build

# Stage 2: nginx to serve SPA and proxy /api
FROM nginx:stable-alpine

# remove default static files (safe-guard)
RUN rm -rf /usr/share/nginx/html/*

# copy nginx site config
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

# copy built frontend into nginx html root (Vite default output: /dist)
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]